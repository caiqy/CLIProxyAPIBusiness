# 认证文件页按模型白名单控制设计

## 背景与目标

当前“模型映射”禁用并不等于模型调用被禁用。为了在管理员面板中实现更直接、可审计的模型访问控制，需要在“认证文件”维度支持“只允许 models 白名单”的能力。

本设计目标：

1. 控制粒度为**单条认证文件**。
2. 当白名单模式开启且 `models` 为空时，语义为**禁止所有模型**。
3. 请求未命中白名单时，对客户端表现为 `model_not_found`。

---

## 需求确认摘要

- 控制粒度：按认证文件。
- 空白名单语义：禁止所有模型。
- 未命中行为：`model_not_found`。
- 采用方案：**方案 B（保存时转换为 excluded_models）**。

---

## 方案对比（已决策）

### 方案 A：新增强制白名单开关字段
- 优点：语义清晰、长期可维护。
- 缺点：需要新增字段与更多运行时逻辑。

### 方案 B：保存时转换为 `excluded_models`（本次采用）
- 思路：保存时根据 `universe - models` 自动生成 `excluded_models`。
- 优点：改动集中在管理端保存链路，运行时几乎不改。
- 缺点：若上游新增模型且未重新保存配置，存在“新模型未被自动排除”的窗口期。

### 方案 C：特殊占位技巧实现全禁
- 优点：实现快。
- 缺点：语义不直观，维护成本高。

---

## 总体设计

在认证文件编辑页新增“白名单模式”交互（可作为表单状态，不强依赖新增 DB 字段）。当管理员保存时，由后端统一执行白名单到黑名单的转换：

1. 获取当前 provider 的候选模型全集 `universe`。
2. 读取管理员提交的允许列表 `models`。
3. 若白名单模式开启：
   - `models` 非空：`excluded_models = universe - models`
   - `models` 为空：`excluded_models = universe`（禁止所有）
4. 按现有结构保存 `models` 与 `excluded_models`。

运行时继续复用现有认证选择逻辑；由于认证已携带 `excluded_models`，不满足模型条件的认证不会被选中。当没有可用认证时，外部表现为 `model_not_found`。

---

## 页面与接口行为

### 前端（管理员面板 / 认证文件）

新增或调整以下交互：

1. 白名单模式开关。
2. `models` 多选组件（支持搜索）。
3. 提示文案：保存后系统会自动计算 `excluded_models`。
4. 当白名单模式开启且 `models` 为空时，提示“将禁止所有模型”。

提交建议：前端传递 `whitelist_enabled` 与 `models`，不在前端计算差集，避免与后端逻辑分叉。

### 后端（Provider API Key Create/Update）

在保存链路新增转换步骤：

1. 标准化 provider。
2. 查询该 provider 的模型全集。
3. 归一化并去重 `models`。
4. 执行差集计算并填充 `excluded_models`。
5. 写库并回显结果。

---

## 数据流

1. 管理员在认证文件页提交配置。
2. 后端读取 provider 模型全集（registry）。
3. 后端计算 `excluded_models` 并写入认证记录。
4. 运行时按已有逻辑筛选认证。
5. 未命中可用认证时返回 `model_not_found`。

---

## 异常处理与边界条件

1. `models` 包含未知模型：返回 `400`，并明确指出非法模型名。
2. provider 模型全集拉取失败：返回 `500`，拒绝保存。
3. 白名单模式开启 + `models=[]`：按“禁止所有”处理（非错误）。
4. 大小写、空格、重复项统一归一化处理，保证比较稳定。

---

## 可观测性与审计

1. 保存成功提示：允许数量与排除数量。
2. 关键日志（脱敏）：`provider`、`auth_id`、`models_count`、`excluded_count`、`whitelist_enabled`。
3. 列表/详情可回显 `models` 与 `excluded_models`，方便管理员核对。

---

## 测试与验收标准

### 后端单测

1. `whitelist_enabled=true, models=[a,b]` => `excluded=universe-[a,b]`。
2. `whitelist_enabled=true, models=[]` => `excluded=universe`。
3. `models` 含未知模型 => `400`。
4. 某模型被全部认证排除 => 调用结果为 `model_not_found`。

### 前端联调

1. 保存后刷新回显一致。
2. 空白名单时该认证不再可用于任意模型。
3. 非法模型提示明确可读。

---

## 风险与后续优化

### 已知风险

方案 B 依赖“保存时快照”。上游新增模型后，若未重新保存认证记录，`excluded_models` 不会自动扩展到新模型。

### 建议优化

1. 增加“按 provider 批量重算白名单”管理操作。
2. 后续可演进为方案 A（显式强制白名单字段），从机制上避免快照漂移。

---

## 结论

本设计以最小运行时改动实现“认证文件页白名单控制”，满足：

- 按认证文件粒度生效；
- 空白名单禁止所有；
- 未命中返回 `model_not_found`。

在可接受“新模型快照漂移”前提下，方案 B 可快速落地，并为后续升级到更强语义方案保留路径。
