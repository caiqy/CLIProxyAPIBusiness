# 管理员最近交易请求日志详情设计

## 背景

当前管理员端“最近交易”列表数据来自 `usages` 表，包含模型、token、状态等汇总信息，但不包含单次上游请求的输入/输出原文。

项目已有 `request-log` 能力（按单次请求写日志文件，文件名包含 `request_id`），但默认配置通常并非始终可用（如 `request-log` 默认关闭、部分运行模式下请求日志中间件可能不启用）。

目标是在管理员“最近交易”列表末列增加日志查看入口，点击后弹窗展示该交易对应的单次请求输入/输出。

## 已确认需求

1. 采用 `request-log` 作为数据来源（不新增“请求原文入库”主路径）。
2. 在 `usages` 增加 `request_id`，用于交易与日志精确一一关联。
3. 列表操作使用“日志图标”按钮，不显示“查看请求”文字。
4. 请求失败场景也需要可查看日志。
5. 日志不可用时按钮仍可点击，弹窗显示错误信息。
6. 弹窗采用分栏原文展示（Request / Response）。
7. 本期按管理员诉求：**不脱敏**，包含敏感请求头与正文原文。

## 非目标

1. 本期不做请求/响应结构化可视化编辑器。
2. 本期不做日志长期归档系统。
3. 本期不改现有交易统计口径与计费逻辑。

## 方案选型

### 方案 A：`usages.request_id` + 回查 request-log 文件（采用）

- 优点：改动集中、落地快、与现有日志能力一致。
- 代价：依赖日志文件存活周期；日志缺失时只能提示不可用。

### 方案 B：请求/响应详情直接入库（未采用）

- 优点：查询稳定，不依赖文件。
- 代价：存储和安全成本更高，改动面更大。

### 方案 C：A + 日志索引表（未采用）

- 优点：可提升日志定位效率。
- 代价：维护复杂度上升，当前收益有限。

## 架构设计

### 1) 数据层

对 `usages` 增加字段：

- `request_id`（字符串，建议加索引）

写 usage 记录时，从请求上下文读取 `request_id` 并持久化。

### 2) 接口层

#### 最近交易列表接口（扩展）

- 现有接口：`GET /v0/admin/dashboard/transactions`
- 每行新增返回：
  - `id`（usage 主键）
  - `request_id`

#### 交易日志详情接口（新增）

- 建议：`GET /v0/admin/dashboard/transactions/:id/request-log`
- 流程：
  1. 按 `id` 读取 usage。
  2. 校验 `request_id` 非空。
  3. 在日志目录匹配 `*-{request_id}.log`（含 `error-` 前缀文件）。
  4. 读取日志并提取 `API REQUEST` 与 `API RESPONSE` 原文段。
  5. 返回给前端弹窗展示。

返回结构建议：

```json
{
  "request_id": "a1b2c3d4",
  "api_request_raw": "...",
  "api_response_raw": "...",
  "source_file": "v1-chat-completions-2026-02-21T120001-a1b2c3d4.log"
}
```

### 3) 前端层

文件：`web/src/components/admin/AdminTransactionsTable.tsx`

改造点：

1. 表格末列增加日志图标按钮（icon button）。
2. 点击图标请求详情接口。
3. 弹窗双栏（或上下）展示原文：
   - Request 区域：`api_request_raw`
   - Response 区域：`api_response_raw`
4. 文本区支持滚动与复制。

## 数据流

1. 入口请求生成 `request_id`，写入上下文。
2. 上游调用完成后（成功或失败），`request-log` 写日志文件，文件名包含 `request_id`。
3. usage 插件落库时写入 `usages.request_id`。
4. 管理员打开最近交易，拿到行级 `id/request_id`。
5. 点击日志图标，后端按交易 `id -> request_id -> 日志文件` 回查并返回原文。

## 错误处理与边界

1. `request_id` 为空（历史数据）：返回明确错误（如 `409`）。
2. 日志文件不存在：返回 `404`（可能被清理、未开启 request-log、或未产生日志）。
3. 日志目录不可读：返回 `500` 并附可读错误文本。
4. 同一 `request_id` 命中多文件：按最新修改时间优先。
5. 前端行为：按钮可点击；失败时弹窗展示后端错误，不静默吞错。

## 安全与权限

1. 仅管理员权限可访问交易日志详情接口。
2. 本期按需求 **原文明文展示，不做脱敏**。
3. 需在文档与界面提示：该能力包含敏感信息，禁止外传截图与复制到不受控环境。

## 与日志保留策略的关系

1. `request-log` 文件可受日志目录总量策略影响（`logs-max-total-size-mb`）。
2. 交易记录（`usages`）存在独立保留策略（默认 90 天）。
3. 因此会出现“交易还在、日志已被清理”的正常情况，前端需展示明确错误提示。

## 测试方案

### 后端

1. 迁移测试：`usages.request_id` 字段存在且可写。
2. 交易列表测试：返回 `id/request_id` 且原有分页筛选不回归。
3. 详情接口测试：
   - 正常请求日志可读；
   - 失败请求日志（含 `error-*.log`）可读；
   - `request_id` 为空、文件缺失、目录异常等错误码正确。

### 前端

1. 列表末列渲染日志图标按钮。
2. 点击后弹窗显示 Request/Response 原文。
3. 接口错误时弹窗展示错误信息。
4. 大文本滚动、复制、关闭交互正常。

### 联调

1. 成功请求：可从最近交易进入并看到完整日志。
2. 失败请求：同样可从最近交易进入并看到错误请求日志。
3. 清理日志后重试：交易仍在，弹窗提示“日志不存在”。

## 验收标准

1. 最近交易列表末列出现日志图标按钮（无文字）。
2. 每条交易可通过 `request_id` 精确定位对应日志文件。
3. 成功与失败请求均可在日志存在时查看输入/输出原文。
4. 日志缺失时前端显示明确错误提示。
5. 明文展示符合本次管理员诉求。
